(function(g){
  function toRows(sheet){return Array.isArray(sheet.__rows)?sheet.__rows:[]}
  const utils={
    sheet_to_json:function(ws){return toRows(ws)},
    json_to_sheet:function(rows){return {__rows:Array.isArray(rows)?rows:[]}}
  };
  function book_new(){return {SheetNames:[],Sheets:{}}}
  function book_append_sheet(wb,ws,name){wb.SheetNames.push(name);wb.Sheets[name]=ws}
  function writeFile(wb,filename){
    const parts=wb.SheetNames.map(function(n){
      const rows=toRows(wb.Sheets[n]);
      if(!rows.length) return '### '+n+'\n';
      const h=Object.keys(rows[0]);
      const lines=[h.join(',')].concat(rows.map(r=>h.map(k=>JSON.stringify(r[k]??'')).join(',')));
      return '### '+n+'\n'+lines.join('\n');
    });
    const blob=new Blob([parts.join('\n\n')],{type:'text/plain'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=filename;a.click();URL.revokeObjectURL(a.href);
  }
  function read(){throw new Error('Import XLSX non disponible dans cette build offline. Utiliser CSV.');}
  g.XLSX={utils:utils,book_new:book_new,writeFile:writeFile,read:read};
  g.XLSX.utils.book_new=book_new; g.XLSX.utils.book_append_sheet=book_append_sheet;
})(window);
